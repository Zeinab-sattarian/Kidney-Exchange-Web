<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kidney Exchange System</title>
    <style>
        /* Kidney Exchange System - Enhanced CSS */

        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: linear-gradient(135deg, #fef7f7 0%, #fdf2f8 50%, #fdf2f8 100%);
            min-height: 100vh;
        }

        /* Enhanced Gradients and Colors */
        .gradient-bg {
            background: linear-gradient(135deg, #fef7f7 0%, #fdf2f8 30%, #f0f9ff 70%, #ecfdf5 100%);
            position: relative;
        }

        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(239, 68, 68, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Header Enhancements */
        header, .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 4rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
            transition: all 0.3s ease;
        }

        .logo-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .logo-text p {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0;
        }

        .header-stats {
            background: rgba(243, 244, 246, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
            border: 1px solid rgba(209, 213, 219, 0.5);
        }

        /* Enhanced Navigation */
        .navigation {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 1.5rem 0;
        }

        .tab-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .tab-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            outline: none;
            position: relative;
            overflow: hidden;
            min-height: 3.5rem;
            white-space: nowrap;
        }

        .tab-active {
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        .tab-inactive {
            background: rgba(255, 255, 255, 0.9);
            color: #6b7280;
            border: 1px solid rgba(229, 231, 235, 0.8);
            backdrop-filter: blur(10px);
        }

        .tab-inactive:hover {
            background: rgba(249, 250, 251, 0.95);
            color: #374151;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid rgba(229, 231, 235, 0.8);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        /* Enhanced Stat Cards */
        .stat-card {
            padding: 1.5rem;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-card-blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 60%, #93c5fd 100%);
            border: 1px solid rgba(147, 197, 253, 0.8);
        }

        .stat-card-green {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 60%, #86efac 100%);
            border: 1px solid rgba(134, 239, 172, 0.8);
        }

        .stat-card-purple {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 60%, #c4b5fd 100%);
            border: 1px solid rgba(196, 181, 253, 0.8);
        }

        .stat-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .stat-text p:first-child {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            opacity: 0.8;
        }

        .stat-text p:last-child {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
        }

        .stat-icon {
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Form Enhancements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid rgba(229, 231, 235, 0.8);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 30%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 30%, #34d399 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        /* Result Cards */
        .result-cycle {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid rgba(147, 197, 253, 0.8);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .result-chain {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 1px solid rgba(134, 239, 172, 0.8);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .result-title {
            font-weight: 700;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .result-path {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            font-family: 'Courier New', monospace;
            opacity: 0.9;
        }

        .result-donations {
            font-size: 0.75rem;
            line-height: 1.6;
        }

        /* Pair Cards */
        .pair-card {
            background: linear-gradient(135deg, rgba(249, 250, 251, 0.9) 0%, rgba(243, 244, 246, 0.9) 100%);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .pair-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .pair-title {
            font-weight: 700;
            color: #111827;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .pair-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .person-info .label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .person-info .name {
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .person-info .details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.5;
        }

        /* Altruistic Cards */
        .altruistic-card {
            background: linear-gradient(135deg, rgba(220, 252, 231, 0.9) 0%, rgba(187, 247, 208, 0.9) 100%);
            border: 1px solid rgba(134, 239, 172, 0.8);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        /* Processing Overlay */
        .processing-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .processing-overlay.hidden {
            display: none;
        }

        .processing-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        .processing-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid rgba(239, 68, 68, 0.2);
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .processing-text h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .processing-text p {
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* Grid Layouts */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

        /* Spacing Utilities */
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }

        .mt-6 { margin-top: 1.5rem; }

        /* Alert Styles */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-warning {
            background: rgba(254, 243, 199, 0.9);
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: rgba(219, 234, 254, 0.9);
            border-color: #3b82f6;
            color: #1e40af;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-cols-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .navigation { padding: 1rem; }
            .header-content { padding: 0 1rem; }
        }

        @media (max-width: 768px) {
            .grid-cols-3,
            .grid-cols-2 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            
            .pair-details { 
                grid-template-columns: 1fr; 
                gap: 0.75rem;
            }
            
            .tab-buttons { 
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body class="min-h-screen gradient-bg">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <svg class="text-white" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                            fill="currentColor" />
                    </svg>
                </div>
                <div class="logo-text">
                    <h1>Kidney Exchange System</h1>
                    <p>Advanced Matching Algorithm</p>
                </div>
            </div>

            <div class="header-stats" id="header-stats">
                0 Pairs • 0 Alt. Donors
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
        <div class="tab-buttons" id="navigation">
            <button class="tab-button tab-active" data-tab="dashboard">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                        fill="none" />
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none" />
                </svg>
                <span>Dashboard</span>
            </button>
            <button class="tab-button tab-inactive" data-tab="management">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" />
                    <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>Manage Pairs</span>
            </button>
            <button class="tab-button tab-inactive" data-tab="results">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="6" y1="3" x2="6" y2="15" stroke="currentColor" stroke-width="2" />
                    <circle cx="18" cy="6" r="3" stroke="currentColor" stroke-width="2" fill="none" />
                    <circle cx="6" cy="18" r="3" stroke="currentColor" stroke-width="2" fill="none" />
                    <path d="m18 9-9 9" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>Results</span>
            </button>
            <button class="tab-button tab-inactive" data-tab="settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none" />
                    <path d="m12 1-3 6-6-3v12l6-3 3 6 3-6 6 3V4l-6 3-3-6z" stroke="currentColor" stroke-width="2"
                        fill="none" />
                </svg>
                <span>Settings</span>
            </button>
        </div>

        <!-- Content -->
        <div id="content" class="space-y-6">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="processing-overlay hidden">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <div class="processing-text">
                <h3>Processing Exchange</h3>
                <p>Building compatibility graph and finding matches...</p>
            </div>
        </div>
    </div>

    <script>
        // Kidney Exchange System - JavaScript Functions

        // ==================== DATA STRUCTURES ====================

        class Person {
            constructor(id, bloodType, hlaMarkers, pra = 0, location = [0, 0]) {
                this.id = id;
                this.bloodType = bloodType;
                this.hlaMarkers = hlaMarkers;
                this.pra = pra;
                this.location = location;
            }
        }

        class KidneyExchange {
            constructor(maxCycleLength = 7, maxChainLength = 5) {
                this.donors = {};
                this.recipients = {};
                this.pairs = {};
                this.altruisticDonors = {};
                this.maxCycleLength = maxCycleLength;
                this.maxChainLength = maxChainLength;

                this.bloodCompatibility = {
                    O: ["O", "A", "B", "AB"],
                    A: ["A", "AB"],
                    B: ["B", "AB"],
                    AB: ["AB"],
                };

                this.graph = {};
                this.scores = {};
            }

            addPair(pairId, donor, recipient) {
                this.pairs[pairId] = [donor.id, recipient.id];
                this.donors[donor.id] = donor;
                this.recipients[recipient.id] = recipient;
            }

            addAltruisticDonor(donor) {
                this.altruisticDonors[donor.id] = donor;
                this.donors[donor.id] = donor;
            }

            isBloodCompatible(donorBlood, recipientBlood) {
                return (
                    this.bloodCompatibility[donorBlood]?.includes(recipientBlood) || false
                );
            }

            calculateDistance(loc1, loc2) {
                return Math.sqrt(
                    Math.pow(loc1[0] - loc2[0], 2) + Math.pow(loc1[1] - loc2[1], 2)
                );
            }

            calculateHlaMatch(donorHla, recipientHla) {
                if (!donorHla.length || !recipientHla.length) return 0.5;

                const donorSet = new Set(donorHla);
                const recipientSet = new Set(recipientHla);
                const intersection = new Set(
                    [...donorSet].filter((x) => recipientSet.has(x))
                );
                const union = new Set([...donorSet, ...recipientSet]);

                return union.size > 0 ? intersection.size / union.size : 0.5;
            }

            calculateScore(donorId, recipientId) {
                const donor = this.donors[donorId];
                const recipient = this.recipients[recipientId];

                if (!this.isBloodCompatible(donor.bloodType, recipient.bloodType)) {
                    return 0.0;
                }

                const hlaScore = this.calculateHlaMatch(
                    donor.hlaMarkers,
                    recipient.hlaMarkers
                );
                const praPenalty = 1.0 - recipient.pra / 100.0;
                const distance = this.calculateDistance(donor.location, recipient.location);
                const distanceScore = Math.max(0.1, 1.0 - distance / 100.0);

                return (hlaScore * 0.5 + praPenalty * 0.3 + distanceScore * 0.2) * 100;
            }

            buildCompatibilityGraph() {
                this.graph = {};
                this.scores = {};

                const allPairs = Object.keys(this.pairs);

                for (const pair1Id of allPairs) {
                    this.graph[pair1Id] = [];
                    const [donor1Id] = this.pairs[pair1Id];

                    for (const pair2Id of allPairs) {
                        if (pair1Id === pair2Id) continue;

                        const [, recipient2Id] = this.pairs[pair2Id];
                        const score = this.calculateScore(donor1Id, recipient2Id);

                        if (score > 0) {
                            this.graph[pair1Id].push(pair2Id);
                            this.scores[`${donor1Id}-${recipient2Id}`] = score;
                        }
                    }
                }

                for (const altDonorId of Object.keys(this.altruisticDonors)) {
                    this.graph[altDonorId] = [];

                    for (const pairId of allPairs) {
                        const [, recipientId] = this.pairs[pairId];
                        const score = this.calculateScore(altDonorId, recipientId);

                        if (score > 0) {
                            this.graph[altDonorId].push(pairId);
                            this.scores[`${altDonorId}-${recipientId}`] = score;
                        }
                    }
                }
            }

            findCycles(targetLength = null, filterPair = null) {
                const cycles = [];
                const allCycles = new Set();

                const dfs = (startPair, currentPair, path) => {
                    if (path.length > this.maxCycleLength) return;

                    if (path.length >= 2 && this.graph[currentPair]?.includes(startPair)) {
                        const cycle = [...path];
                        const minIdx = cycle.indexOf(Math.min(...cycle));
                        const normalized = [...cycle.slice(minIdx), ...cycle.slice(0, minIdx)];
                        const cycleKey = normalized.join("-");

                        if (!allCycles.has(cycleKey)) {
                            allCycles.add(cycleKey);
                            cycles.push(normalized);
                        }
                    }

                    for (const neighbor of this.graph[currentPair] || []) {
                        if (neighbor !== currentPair && !path.includes(neighbor)) {
                            path.push(neighbor);
                            dfs(startPair, neighbor, path);
                            path.pop();
                        }
                    }
                };

                for (const pairId of Object.keys(this.pairs)) {
                    dfs(pairId, pairId, [pairId]);
                }

                let filteredCycles = cycles;
                if (targetLength) {
                    filteredCycles = cycles.filter((cycle) => cycle.length === targetLength);
                }
                if (filterPair) {
                    filteredCycles = filteredCycles.filter((cycle) =>
                        cycle.includes(filterPair)
                    );
                }

                return filteredCycles;
            }

            findChains(targetLength = null, filterPair = null) {
                const chains = [];

                const dfsChain = (currentNode, path, visitedPairs) => {
                    if (path.length > this.maxChainLength) return;

                    if (path.length > 1) {
                        chains.push([...path]);
                    }

                    if (this.pairs[currentNode]) {
                        visitedPairs.add(currentNode);
                    }

                    for (const neighbor of this.graph[currentNode] || []) {
                        if (!visitedPairs.has(neighbor)) {
                            path.push(neighbor);
                            dfsChain(neighbor, path, visitedPairs);
                            path.pop();
                        }
                    }

                    if (this.pairs[currentNode]) {
                        visitedPairs.delete(currentNode);
                    }
                };

                for (const altDonorId of Object.keys(this.altruisticDonors)) {
                    dfsChain(altDonorId, [altDonorId], new Set());
                }

                let filteredChains = chains;
                if (targetLength) {
                    filteredChains = chains.filter((chain) => chain.length === targetLength);
                }
                if (filterPair) {
                    filteredChains = filteredChains.filter((chain) =>
                        chain.includes(filterPair)
                    );
                }

                return filteredChains;
            }
        }

        // ==================== SAMPLE DATA ====================

        function createSampleData() {
            const exchange = new KidneyExchange(6, 4);

            const pairsData = [
                [
                    "P1",
                    ["D1", "A", ["HLA-A1", "HLA-B7"], [40.7, -74.0]],
                    ["R1", "B", ["HLA-A2", "HLA-B8"], 30, [40.7, -74.0]],
                ],
                [
                    "P2",
                    ["D2", "B", ["HLA-A2", "HLA-B8"], [40.8, -74.1]],
                    ["R2", "A", ["HLA-A1", "HLA-B7"], 20, [40.8, -74.1]],
                ],
                [
                    "P3",
                    ["D3", "O", ["HLA-A3", "HLA-B9"], [40.9, -74.2]],
                    ["R3", "AB", ["HLA-A1", "HLA-B7"], 40, [40.9, -74.2]],
                ],
                [
                    "P4",
                    ["D4", "AB", ["HLA-A1", "HLA-B7"], [41.0, -74.3]],
                    ["R4", "O", ["HLA-A3", "HLA-B9"], 10, [41.0, -74.3]],
                ],
                [
                    "P5",
                    ["D5", "A", ["HLA-A2", "HLA-B8"], [40.6, -74.4]],
                    ["R5", "O", ["HLA-A1", "HLA-B7"], 25, [40.6, -74.4]],
                ],
                [
                    "P6",
                    ["D6", "B", ["HLA-A3", "HLA-B9"], [40.5, -74.5]],
                    ["R6", "AB", ["HLA-A2", "HLA-B8"], 35, [40.5, -74.5]],
                ],
            ];

            pairsData.forEach(([pairId, donorData, recipientData]) => {
                const donor = new Person(
                    donorData[0],
                    donorData[1],
                    donorData[2],
                    0,
                    donorData[3]
                );
                const recipient = new Person(
                    recipientData[0],
                    recipientData[1],
                    recipientData[2],
                    recipientData[3],
                    recipientData[4]
                );
                exchange.addPair(pairId, donor, recipient);
            });

            const altDonor = new Person(
                "AD1",
                "O",
                ["HLA-A1", "HLA-B7"],
                0,
                [40.6, -73.9]
            );
            exchange.addAltruisticDonor(altDonor);

            return exchange;
        }

        // ==================== GLOBAL STATE ====================

        let exchange = createSampleData();
        let currentTab = "dashboard";
        let results = { cycles: [], chains: [] };
        let filters = {
            filterPair: "",
            targetCycleLength: "",
            targetChainLength: "",
        };

        // ==================== UI UTILITY FUNCTIONS ====================

        function updateHeaderStats() {
            const pairCount = Object.keys(exchange.pairs).length;
            const altCount = Object.keys(exchange.altruisticDonors).length;
            document.getElementById(
                "header-stats"
            ).textContent = `${pairCount} Pairs • ${altCount} Alt. Donors`;
        }

        function showProcessingOverlay() {
            const overlay = document.getElementById("processing-overlay");
            overlay.classList.remove("hidden");
        }

        function hideProcessingOverlay() {
            const overlay = document.getElementById("processing-overlay");
            overlay.classList.add("hidden");
        }

        // ==================== TAB NAVIGATION ====================

        function showTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll(".tab-button").forEach((btn) => {
                btn.classList.remove("tab-active");
                btn.classList.add("tab-inactive");
            });
            document
                .querySelector(`[data-tab="${tabName}"]`)
                .classList.remove("tab-inactive");
            document.querySelector(`[data-tab="${tabName}"]`).classList.add("tab-active");

            // Update content
            const content = document.getElementById("content");
            switch (tabName) {
                case "dashboard":
                    content.innerHTML = renderDashboard();
                    break;
                case "management":
                    content.innerHTML = renderManagement();
                    break;
                case "results":
                    content.innerHTML = renderResults();
                    break;
                case "settings":
                    content.innerHTML = renderSettings();
                    break;
            }
        }

        // ==================== RENDER FUNCTIONS ====================

        function renderDashboard() {
            const pairCount = Object.keys(exchange.pairs).length;
            const altCount = Object.keys(exchange.altruisticDonors).length;
            const matchCount = results.cycles.length + results.chains.length;

            let pairsHtml = "";
            Object.entries(exchange.pairs).forEach(([pairId, [donorId, recipientId]]) => {
                const donor = exchange.donors[donorId];
                const recipient = exchange.recipients[recipientId];
                pairsHtml += `
                    <div class="pair-card">
                        <h4 class="pair-title">${pairId}</h4>
                        <div class="pair-details">
                            <div class="person-info">
                                <span class="label">Donor</span>
                                <p class="name">${donorId} (${donor.bloodType})</p>
                                <p class="details">HLA: ${donor.hlaMarkers.join(", ")}</p>
                            </div>
                            <div class="person-info">
                                <span class="label">Recipient</span>
                                <p class="name">${recipientId} (${recipient.bloodType})</p>
                                <p class="details">HLA: ${recipient.hlaMarkers.join(", ")}</p>
                                <p class="details">PRA: ${recipient.pra}%</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            let altDonorsHtml = "";
            if (Object.keys(exchange.altruisticDonors).length > 0) {
                Object.entries(exchange.altruisticDonors).forEach(([donorId, donor]) => {
                    altDonorsHtml += `
                        <div class="altruistic-card">
                            <h4 class="pair-title">${donorId}</h4>
                            <div class="person-info">
                                <p class="name">Blood Type: ${donor.bloodType}</p>
                                <p class="details">HLA: ${donor.hlaMarkers.join(", ")}</p>
                                <p class="details">Location: ${donor.location.join(", ")}</p>
                            </div>
                        </div>
                    `;
                });

                altDonorsHtml = `
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Altruistic Donors</h3>
                            <div class="grid grid-cols-3">
                                ${altDonorsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-3">
                        <div class="stat-card stat-card-blue">
                            <div class="stat-content">
                                <div class="stat-text">
                                    <p>Total Pairs</p>
                                    <p>${pairCount}</p>
                                </div>
                                <svg class="stat-icon" width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-card-green">
                            <div class="stat-content">
                                <div class="stat-text">
                                    <p>Altruistic Donors</p>
                                    <p>${altCount}</p>
                                </div>
                                <svg class="stat-icon" width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-card-purple">
                            <div class="stat-content">
                                <div class="stat-text">
                                    <p>Found Matches</p>
                                    <p>${matchCount}</p>
                                </div>
                                <svg class="stat-icon" width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <line x1="6" y1="3" x2="6" y2="15" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="18" cy="6" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                                    <circle cx="6" cy="18" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                                    <path d="m18 9-9 9" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Current Pairs</h3>
                            <div class="grid grid-cols-2">
                                ${pairsHtml}
                            </div>
                        </div>
                    </div>

                    ${altDonorsHtml}
                </div>
            `;
        }

        function renderManagement() {
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Add New Pair</h3>
                            
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Pair ID</label>
                                    <input type="text" id="pairId" class="form-input" placeholder="P7">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Location (lat, lng)</label>
                                    <input type="text" id="location" value="40.7, -74.0" class="form-input" placeholder="40.7, -74.0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Donor ID</label>
                                    <input type="text" id="donorId" class="form-input" placeholder="D7">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Donor Blood Type</label>
                                    <select id="donorBloodType" class="form-select">
                                        <option value="O">O</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="AB">AB</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Donor HLA (comma separated)</label>
                                    <input type="text" id="donorHla" class="form-input" placeholder="HLA-A1, HLA-B7">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Recipient ID</label>
                                    <input type="text" id="recipientId" class="form-input" placeholder="R7">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Recipient Blood Type</label>
                                    <select id="recipientBloodType" class="form-select">
                                        <option value="O">O</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="AB">AB</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Recipient HLA (comma separated)</label>
                                    <input type="text" id="recipientHla" class="form-input" placeholder="HLA-A2, HLA-B8">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">PRA (%)</label>
                                    <input type="number" min="0" max="100" id="pra" value="0" class="form-input" placeholder="25">
                                </div>
                            </div>
                            
                            <button onclick="addNewPair()" class="btn btn-secondary mt-6">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
                                    <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                <span>Add Pair</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            let pairOptions = "";
            Object.keys(exchange.pairs).forEach((pairId) => {
                pairOptions += `<option value="${pairId}">${pairId}</option>`;
            });

            let cyclesHtml = "";
            if (results.cycles.length > 0) {
                results.cycles.forEach((cycle, index) => {
                    let donationsHtml = "";
                    cycle.forEach((pairId, i) => {
                        const nextPairId = cycle[(i + 1) % cycle.length];
                        const [donorId] = exchange.pairs[pairId];
                        const [, recipientId] = exchange.pairs[nextPairId];
                        const donor = exchange.donors[donorId];
                        const recipient = exchange.recipients[recipientId];
                        donationsHtml += `<p>${donorId} (${donor.bloodType}) → ${recipientId} (${recipient.bloodType})</p>`;
                    });

                    cyclesHtml += `
                        <div class="result-cycle">
                            <h4 class="result-title">
                                Cycle ${index + 1} (Length: ${cycle.length})
                            </h4>
                            <p class="result-path">
                                Path: ${cycle.join(" → ")} → ${cycle[0]}
                            </p>
                            <div class="result-donations">
                                <p><strong>Donations:</strong></p>
                                ${donationsHtml}
                            </div>
                        </div>
                    `;
                });
            } else {
                cyclesHtml = '<p style="color: #6b7280;">No cycles found.</p>';
            }

            let chainsHtml = "";
            if (results.chains.length > 0) {
                results.chains.forEach((chain, index) => {
                    let donationsHtml = "";
                    chain.slice(0, -1).forEach((nodeId, i) => {
                        const nextNodeId = chain[i + 1];
                        let donorId, recipientId, donor, recipient;

                        if (i === 0) {
                            donorId = nodeId;
                            [, recipientId] = exchange.pairs[nextNodeId];
                            donor = exchange.altruisticDonors[donorId];
                        } else {
                            [donorId] = exchange.pairs[nodeId];
                            [, recipientId] = exchange.pairs[nextNodeId];
                            donor = exchange.donors[donorId];
                        }

                        recipient = exchange.recipients[recipientId];
                        donationsHtml += `<p>${donorId} (${donor.bloodType}) → ${recipientId} (${recipient.bloodType})</p>`;
                    });

                    chainsHtml += `
                        <div class="result-chain">
                            <h4 class="result-title">
                                Chain ${index + 1} (Length: ${chain.length})
                            </h4>
                            <p class="result-path">
                                Path: ${chain.join(" → ")}
                            </p>
                            <div class="result-donations">
                                <p><strong>Donations:</strong></p>
                                ${donationsHtml}
                            </div>
                        </div>
                    `;
                });
            } else {
                chainsHtml = '<p style="color: #6b7280;">No chains found.</p>';
            }

            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Exchange Filters</h3>
                            <div class="grid grid-cols-3">
                                <div class="form-group">
                                    <label class="form-label">Filter by Pair</label>
                                    <select id="filterPair" class="form-select">
                                        <option value="">All Pairs</option>
                                        ${pairOptions}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Target Cycle Length</label>
                                    <input type="number" min="2" max="${exchange.maxCycleLength}" id="targetCycleLength" class="form-input" placeholder="Any length">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Target Chain Length</label>
                                    <input type="number" min="2" max="${exchange.maxChainLength}" id="targetChainLength" class="form-input" placeholder="Any length">
                                </div>
                            </div>
                            
                            <button onclick="runExchange()" class="btn btn-primary mt-6">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <polygon points="5,3 19,12 5,21 5,3" stroke="currentColor" stroke-width="2" fill="currentColor"/>
                                </svg>
                                <span>Run Exchange</span>
                            </button>
                        </div>
                    </div>

                    ${results.cycles.length > 0 || results.chains.length > 0
                        ? `
                        <div class="grid grid-cols-2">
                            <div class="card">
                                <div class="card-body">
                                    <h3 class="card-title">
                                        Found Cycles (${results.cycles.length})
                                    </h3>
                                    <div class="space-y-4">
                                        ${cyclesHtml}
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <h3 class="card-title">
                                        Found Chains (${results.chains.length})
                                    </h3>
                                    <div class="space-y-4">
                                        ${chainsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `
                        : results.cycles.length === 0 &&
                          results.chains.length === 0 &&
                          Object.keys(results).length > 0
                        ? `
                        <div class="alert alert-warning">
                            <p>
                                No matches found. Try adjusting your filters or adding more pairs.
                            </p>
                        </div>
                    `
                        : ""
                    }
                </div>
            `;
        }

        function renderSettings() {
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Algorithm Settings</h3>
                            
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">
                                        Maximum Cycle Length
                                    </label>
                                    <input type="number" min="2" max="10" value="${exchange.maxCycleLength}" id="maxCycleLength" class="form-input" onchange="updateMaxCycleLength(this.value)">
                                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                        Maximum number of pairs in a cycle (typically 2-6)
                                    </p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Maximum Chain Length
                                    </label>
                                    <input type="number" min="2" max="10" value="${exchange.maxChainLength}" id="maxChainLength" class="form-input" onchange="updateMaxChainLength(this.value)">
                                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                        Maximum number of pairs in a chain (typically 2-5)
                                    </p>
                                </div>
                            </div>
                            
                            <button onclick="loadSampleData()" class="btn btn-secondary mt-6">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="m21 15-4-4h3V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v7h3l-4 4" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                <span>Load Sample Data</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h3 class="card-title">About the Algorithm</h3>
                        <div class="space-y-2">
                            <p>
                                <strong>Compatibility Scoring:</strong> The system uses a weighted scoring function considering:
                            </p>
                            <ul style="list-style-type: disc; margin-left: 1rem; margin-top: 0.25rem;">
                                <li>HLA marker compatibility (50% weight)</li>
                                <li>PRA (Panel Reactive Antibody) levels (30% weight)</li>
                                <li>Geographic distance between donors and recipients (20% weight)</li>
                            </ul>
                            
                            <p style="margin-top: 1rem;">
                                <strong>Exchange Types:</strong>
                            </p>
                            <ul style="list-style-type: disc; margin-left: 1rem; margin-top: 0.25rem;">
                                <li><strong>Cycles:</strong> Closed loops where each donor gives to the next recipient in the cycle</li>
                                <li><strong>Chains:</strong> Open sequences starting with an altruistic donor</li>
                            </ul>
                            
                            <p style="margin-top: 1rem;">
                                <strong>Blood Type Compatibility:</strong> O → O,A,B,AB | A → A,AB | B → B,AB | AB → AB
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== EVENT HANDLERS ====================

        function addNewPair() {
            const pairId = document.getElementById("pairId").value.trim();
            const donorId = document.getElementById("donorId").value.trim();
            const recipientId = document.getElementById("recipientId").value.trim();

            if (!pairId || !donorId || !recipientId) {
                alert("Please fill in all required fields");
                return;
            }

            const location = document
                .getElementById("location")
                .value.split(",")
                .map((s) => parseFloat(s.trim()));
            const donorBloodType = document.getElementById("donorBloodType").value;
            const recipientBloodType =
                document.getElementById("recipientBloodType").value;
            const donorHla = document
                .getElementById("donorHla")
                .value.split(",")
                .map((s) => s.trim())
                .filter((s) => s);
            const recipientHla = document
                .getElementById("recipientHla")
                .value.split(",")
                .map((s) => s.trim())
                .filter((s) => s);
            const pra = parseInt(document.getElementById("pra").value) || 0;

            // Create new exchange with all existing data plus new pair
            const newExchange = new KidneyExchange(
                exchange.maxCycleLength,
                exchange.maxChainLength
            );

            // Copy all existing pairs
            Object.keys(exchange.pairs).forEach((pairIdOld) => {
                const [donorIdOld, recipientIdOld] = exchange.pairs[pairIdOld];
                newExchange.addPair(
                    pairIdOld,
                    exchange.donors[donorIdOld],
                    exchange.recipients[recipientIdOld]
                );
            });

            // Copy all existing altruistic donors
            Object.keys(exchange.altruisticDonors).forEach((altId) => {
                newExchange.addAltruisticDonor(exchange.altruisticDonors[altId]);
            });

            // Add new pair
            const donor = new Person(donorId, donorBloodType, donorHla, 0, location);
            const recipient = new Person(
                recipientId,
                recipientBloodType,
                recipientHla,
                pra,
                location
            );
            newExchange.addPair(pairId, donor, recipient);

            exchange = newExchange;

            // Reset form
            clearAddPairForm();

            updateHeaderStats();
            alert("Pair added successfully!");
        }

        function clearAddPairForm() {
            document.getElementById("pairId").value = "";
            document.getElementById("donorId").value = "";
            document.getElementById("recipientId").value = "";
            document.getElementById("donorHla").value = "";
            document.getElementById("recipientHla").value = "";
            document.getElementById("pra").value = "0";
        }

        async function runExchange() {
            showProcessingOverlay();

            // Get filters
            const filterPair = document.getElementById("filterPair")?.value || "";
            const targetCycleLength = document.getElementById("targetCycleLength")?.value
                ? parseInt(document.getElementById("targetCycleLength").value)
                : null;
            const targetChainLength = document.getElementById("targetChainLength")?.value
                ? parseInt(document.getElementById("targetChainLength").value)
                : null;

            // Simulate processing time
            await new Promise((resolve) => setTimeout(resolve, 1500));

            try {
                exchange.buildCompatibilityGraph();

                const cycles = exchange.findCycles(targetCycleLength, filterPair || null);
                const chains = exchange.findChains(targetChainLength, filterPair || null);

                results = { cycles, chains };

                hideProcessingOverlay();

                // Re-render results tab
                showTab("results");
            } catch (error) {
                console.error("Error running exchange:", error);
                hideProcessingOverlay();
                alert("An error occurred while running the exchange. Please try again.");
            }
        }

        function updateMaxCycleLength(value) {
            const newLength = parseInt(value) || 6;
            const newExchange = new KidneyExchange(newLength, exchange.maxChainLength);

            // Copy all existing data
            copyExchangeData(newExchange);

            exchange = newExchange;
        }

        function updateMaxChainLength(value) {
            const newLength = parseInt(value) || 4;
            const newExchange = new KidneyExchange(exchange.maxCycleLength, newLength);

            // Copy all existing data
            copyExchangeData(newExchange);

            exchange = newExchange;
        }

        function copyExchangeData(newExchange) {
            // Copy all existing pairs
            Object.keys(exchange.pairs).forEach((pairId) => {
                const [donorId, recipientId] = exchange.pairs[pairId];
                newExchange.addPair(
                    pairId,
                    exchange.donors[donorId],
                    exchange.recipients[recipientId]
                );
            });

            // Copy all existing altruistic donors
            Object.keys(exchange.altruisticDonors).forEach((altId) => {
                newExchange.addAltruisticDonor(exchange.altruisticDonors[altId]);
            });
        }

        function loadSampleData() {
            exchange = createSampleData();
            results = { cycles: [], chains: [] };
            updateHeaderStats();
            showTab("dashboard");
            alert("Sample data loaded successfully!");
        }

        // ==================== INITIALIZATION ====================

        function initializeApp() {
            // Setup tab navigation
            document.querySelectorAll(".tab-button").forEach((btn) => {
                btn.addEventListener("click", function () {
                    showTab(this.dataset.tab);
                });
            });

            // Initialize with dashboard
            updateHeaderStats();
            showTab("dashboard");
        }

        // ==================== DOM READY ====================

        document.addEventListener("DOMContentLoaded", function () {
            initializeApp();
        });
    </script>
</body>

</html>